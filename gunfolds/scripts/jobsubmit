#!/bin/bash
#SBATCH -N 1
#SBATCH -n 1
#SBATCH -c 1
#SBATCH --mem=10m
#SBATCH -p qTRDGPU
#SBATCH -t 5
#SBATCH -J data
#SBATCH -e ./err/error%A-%a.err
#SBATCH -o ./out/out%A-%a.out
#SBATCH -A psy53c17
#SBATCH --mail-type=ALL
#SBATCH --mail-user=mabavisani@gsu.edu
#SBATCH --oversubscribe

# Parameters
PYTHON_SCRIPT="print.py"  # Set the Python script name here
LOG_DIR="./logs"

# Job-specific parameters
b=$(( ($SLURM_ARRAY_TASK_ID - 1) % 60 + 1 ))
n=$(( (($SLURM_ARRAY_TASK_ID - 1) / 60) + 1 ))
p=15
o=RASL

# Combine parameters into a single variable
SCRIPT_PARAMS="-b=$b -n=$n"

# Ensure logs directory exists
mkdir -p "$LOG_DIR"

# Create a single log file for all array jobs (only done once)
LOG_FILE="$LOG_DIR/job_${SLURM_ARRAY_JOB_ID}.log"

if [ ! -f "$LOG_FILE" ]; then
    {
        echo "Date and Time: $(date)"
        echo "**********************************************************"
        echo "Job ID: $SLURM_ARRAY_JOB_ID"
        echo -e "\nContents of jobsubmit:"
        cat "$0"  # Log the contents of this script
        echo "**********************************************************"
        echo -e "\nContents of $PYTHON_SCRIPT:"
        cat "$PYTHON_SCRIPT"  # Log the contents of the Python script
        echo -e "\nScript Parameters: $SCRIPT_PARAMS"
        echo "**********************************************************"
    } > "$LOG_FILE"
fi

sleep 1s

# Update job name with parameters
job_name="f8_${b}_${o}"
scontrol update jobid=$SLURM_JOB_ID name=$job_name

# Update the number of CPUs allocated
scontrol update jobid=$SLURM_JOB_ID NumCPUs=$p

# Set OMP_NUM_THREADS to the value of $p
export OMP_NUM_THREADS=$p

export MODULEPATH=/apps/Compilers/modules-3.2.10/Debug-Build/Modules/3.2.10/modulefiles/
echo $HOSTNAME >&2

source /home/users/mabavisani/anaconda3/bin/activate
conda activate multi_v3

# Add array-specific details to the log
{
    echo "Array Task ID: $SLURM_ARRAY_TASK_ID"
    echo "Script Parameters: $SCRIPT_PARAMS"
} >> "$LOG_FILE"

# Run the Python script with parameters
python "$PYTHON_SCRIPT" $SCRIPT_PARAMS